<TMPL_IF NAME='MAIN'>
<link rel="stylesheet" type="text/css" href="js/vendor/datatables/media/css/jquery.dataTables.min.css">
<script type="text/javascript" language="javascript" src="js/vendor/datatables/media/js/jquery.dataTables.js"></script>
<style>
#chr_list_table {
  white-space: nowrap;
}
#chr_list_table td {
  font-size: small;
}
#chr_list_table th {
	color: dimgray !important;
	font-size: small;
	text-align: left;
}
.dataTables_wrapper .dataTables_paginate .paginate_button {
	color:#0000EE !important;
}
.dataTables_wrapper .dataTables_paginate .paginate_button:hover {
    color:#009900!important;
    border:1px solid transparent !important;
    background:none !important;
}
.dataTables_info{ font-size: small; }
</style>
<script src="./js/coge/utils.js"></script>
<script language="javascript" type="text/javascript" src="./js/jquery.tablesorter.2.0.3.js"></script>
<script language="javascript" type="text/javascript" src="./js/jquery.tablesorter.pager.js"></script>
<script language="javascript" type="text/javascript" src="./js/jquery.fileupload.js"></script>

<script language="javascript">

var job_id = "<TMPL_VAR NAME=JOB_ID>",
    genome_id = "<TMPL_VAR NAME=GID>",
    load_id = "<TMPL_VAR NAME=LOAD_ID>",
    default_type = "<TMPL_VAR NAME=DEFAULT_TYPE>",
    irods_home_path = "<TMPL_VAR NAME=IRODS_HOME>",
    PAGE_NAME = "<TMPL_VAR NAME=PAGE_NAME>",
    DISCOVERY_ENVIRONMENT = "https://de.iplantcollaborative.org/de/?type=data&folder=",
    newLoad = false;

// EXPORT DIALOG GLOBALS
var irods_home = $("<p>Sending to: " + irods_home_path + "</p>");
var export_error = $("<p></p>")
    .text("Failed to export to the iPlant Data Store.")
    .addClass("alert");
var download_error = $("<p></p>")
    .text("The file could not be fetched")
    .addClass("alert");
var spinner = $("<img></img>").attr("src", "picts/ajax-loader.gif");
var message = $("<div></div>").text("Please wait...  ").append(spinner.clone());
var note = $("<p></p>").addClass("small")
        .text("(This may take several minutes)");

$(document).ready(function() {
    pageObj = new Object();
    pageObj.timers = new Array();

    pageObj.user = "<TMPL_VAR NAME=USER>";

    $.ajaxSetup({
        type: "GET",
        url: PAGE_NAME,
        dataType: "html",
        cache: false,
        timeout: 5*60*60*1000 // 5 hours -- mdb added 7/22/15 for AA usage, codon usage, etc.
    });

    $(".dialog_box").dialog({ autoOpen: false, width: '30em' });

    $("#status_dialog").dialog({modal: true});

    $("#export_dialog").dialog({modal: true});

    set_annotation_table();

    init_annotation_dialog(genome_id, default_type);
    
    // Open status dialog
    if (job_id) {
        reset_log();
        $('#loading_msg').hide();
        $('#load_dialog').dialog('open');
        update_dialog("api/v1/jobs/" + job_id, pageObj.user, $("#load_dialog"), progress_formatter);
    }
});

function get_gc_content(id, fname) {
    var elem = $(id);
    elem.hide().html(spinner.clone()).fadeIn();
    elem.attr("onclick", '')
        .unbind()
        .removeClass("link")
        .addClass("data5");

    $.ajax({
        dataType: "html",
        data: {
            fname: fname,
            dsgid: genome_id,
            gstid: $("#gstid").val()
        },
        success: function(data) {
            elem.fadeOut(function() {;
                elem.html(data).fadeIn();
            });
        }
    });
}

function get_feat_gc(opts){
    var elem = $('#gc_histogram');
    elem.dialog("option", "position", {
        my: "center",
        at: "top",
        of: $(".box")
    });
    elem.dialog("open");

    if (!opts){opts={};}
    chr = opts.chr;
    typeid = opts.typeid;
    min = $('#feat_gc_min').val();
    max = $('#feat_gc_max').val();
    hist_type = $('#feat_hist_type').val();
    dsid = opts.dsid;
    dsgid = $('#dsg_id').val();
    elem.html('loading. . .');

    $.ajax({
        data: {
                dsgid: genome_id,
                fname: 'get_gc_for_feature_type',
                dsid: dsid,
                typeid: typeid,
                chr: chr,
                min: min,
                max: max,
                hist_type: hist_type
            },
            success: function(data) {
                elem.html(data);
            }
        });
}

function chr_hist (dsgid) {
    $('#chromosome_hist').dialog({
        autoOpen: true,
        position: {
           my: "top",
           at: "top",
           of: window
        }
    });

    $('#chromosome_hist').html('loading. . .');
    $.ajax({
        data: {
            fname: 'get_chr_length_hist',
            dsgid: dsgid
        },
        success: function (data) {$('#chromosome_hist').html(data);}
    });
}

var chr_list_table = null;
function chr_list() {
	$('#chromosome_list').dialog({
		autoOpen: true,
		position: {
			my: "top",
			at: "top",
			of: window
		}
	});

	if (!chr_list_table)
	    $.ajax({
	        data: {
	            fname: 'get_chromosomes',
	            gid: genome_id
	        },
	        dataType: "json",
	        success: function (data) {
				chr_list_table = $('#chr_list_table').DataTable({
			   		columnDefs:[{targets:1,type:'num'},{orderable:false,targets:[2,3]}],
			   		data:data,
					deferRender:true,
					language:{info:'Showing _START_ to _END_ of _TOTAL_ chromosomes'},
					lengthChange:false,
					paging:data.length>10,
					pagingType:'simple',
					searching:data.length>10
				});
				$('#chr_list_loading').hide();
				$('#chr_list').show();
	        }
		});
 }

function download_chromosome_sequence(chr) {
    $.ajax({
        data: {
            fname: 'cache_chr_fasta',
            gid: genome_id,
            chr: chr
        },
        success: function(data) {
        	document.location='bin/get_seq_for_chr.pl?gid=' + genome_id + '&chr=' + chr;
        }
    });
}

function download_chr_file() {
	var i = $('input[name=chr]:checked');
	if (!i.length) {
		alert('Please select one of the files to download first.');
		return;
	}
	var id = i.attr('id');
	if (id.substring(0,1)=='f')
		download_chromosome_sequence(id.substring(1));
	else
		get_gff(id.substring(1));
}

function export_chr_file() {
	var i = $('input[name=chr]:checked');
	if (!i.length) {
		alert('Please select one of the files to export first.');
		return;
	}
	var id = i.attr('id');
	if (id.substring(0,1)=='f')
		export_fasta_chr(id.substring(1));
	else
		export_gff(id.substring(1));
}

function toggle_load_log() {
	var btn = $('#log_button');
	var log = $('#log_contents');
	var spinner = $('#log_spinner');
	
	var setVisible = function(visible) { // TODO: i want to use jQuery.toggle() instead, oh well
    	if (visible) {
			log.removeClass('hidden');
	    	btn.html('Hide');
	    	spinner.animate({opacity:0});
    	}
    	else {
    		log.addClass('hidden');
    		btn.html('Show');
    		spinner.animate({opacity:0});
    	}
	}
	
	if (log.is(":hidden")) {
		if (log.html() == '') {
			spinner.css({opacity:1});
			$.ajax({
		        data: {
		            fname: 'get_load_log',
		            gid: genome_id
		        },
		        success: function(data) {
		        	if (data)
		        		log.html(data);
		        	else
		        		log.html('<span class="alert">Error: log file not found</span>');
		        	setVisible(true);
		        }
		    });
		}
		else
			setVisible(true);
	}
	else
		setVisible(false);
}

function export_features_to_irods(id, feature, isGenome, type) {
    // Prevent concurrent executions
    if ( $("#export_dialog").dialog( "isOpen" ) )
        return;

    // Make sure user is still logged-in
    if (!check_and_report_login())
        return;

    // RESET DIALOG
    reset_dialog();

    // Open status dialog right away
    $('#export_dialog')
        .unbind()
        .dialog('open');

    var data = {
        fname: "export_features",
        protein: type,
        fid: feature
    };

    var link = $("<a></a>")
            .addClass("bold")
            .attr("href", DISCOVERY_ENVIRONMENT.concat(irods_home_path))
            .html(irods_home_path);

    if (data.protein) {
        $('#export_log').html(
            "<br>Copying protein sequences to <br><br>"
        ).append(link);
    } else {
        $('#export_log').html(
            "<br>Copying nucleotide sequences to <br><br>"
        ).append(link);

    }

    if (isGenome) {
        data.gid = id;
    } else {
        data.dsid = id;
    }

    $.ajax({
        data: data,
        dataType: "json",
        success: function(json) {
            if (json.error) {
                show_error();
            } else {
                $('#export_log').append('<br><br>File: ' + json.file);
                show_success();
            }
        }
    });
}

function debounce_search(search_func, search_term) {
    pageObj.search_term = search_term;

    if (pageObj.time) {
        clearTimeout(pageObj.time);
    }

    // FIXME: could generalize by passing select id instead of separate search_* functions
    pageObj.time = setTimeout(
        function() {
            search_func(pageObj.search_term);
        },
        500
    );
}

function search_organisms (search_term) {
    if (search_term.length > 2) {
        $.ajax({
            data: {
                fname: 'search_organisms',
                search_term: search_term,
                timestamp: new Date().getTime()
            },
            success : function(data) {
                var obj = jQuery.parseJSON(data);
                if (obj && obj.items) {
                    $("#edit_organism").autocomplete({source: obj.items});
                    $("#edit_organism").autocomplete("search");
                }
            }
        });
    }
}

function get_features(selector) {
    var elem = $(selector);
    elem.html(spinner.clone())
        .attr("onclick", "")
        .unbind()
        .fadeIn();

    $.ajax({
        data: {
            fname: "get_features",
            dsgid: genome_id,
            gstid: $("#gstid").val()
        },
        success: function(data) {
            elem.fadeOut(function() {;
                elem.html(data).removeClass("small link padded ui-widget-content ui-corner-all").slideDown();
            });
        }
    })
};

function search_users (search_term) {
    $.ajax({
        data: {
            fname: 'search_users',
            search_term: search_term,
            timestamp: new Date().getTime()
        },
        success : function(data) {
            var obj = jQuery.parseJSON(data);
            if (obj && obj.items) {
                $("#edit_user").autocomplete({source: obj.items});
                $("#edit_user").autocomplete("search");
            }
        },
    });
}

function get_genome_info () {
    $.ajax({
        data: {
            fname: 'get_genome_info',
            gid: genome_id
        },
        success : function(data) {
            if (data) {
                $("#genome_info").html(data);
            }
        }
    });
}

function edit_genome_info () {
    $.ajax({
        data: {
            fname: 'edit_genome_info',
            gid: genome_id
        },
        success : function(data) {
            if (data) {
                $("#genome_info_edit_box").html(data).dialog('open');
            }
        }
    });
}

function update_genome_info (){
    var org_name = $('#edit_organism').val();
    if (!org_name) {
        alert('Please select an organism.');
        return;
    }

    var version = $('#edit_version').val();
    if (!version) {
        alert('Please specify a genome version.');
        return;
    }

    var source_name = $('#edit_source').val();
    if (!source_name) {
        alert('Please specify a data source.');
        return;
    }

    var link = $('#edit_link').val();
    var name = $('#edit_name').val();
    var description = $('#edit_description').val();
    var type_id = $('#select_type').val();
    var restricted = $('#restricted').is(':checked');

    $.ajax({
        data: {
            fname: 'update_genome_info',
            gid: genome_id,
            name: name,
            description: description,
            version: version,
            type_id: type_id,
            restricted: restricted,
            org_name: org_name,
            source_name: source_name,
            link: link,
            timestamp: new Date().getTime()
        },
        success : function(val) {
            if (val) {
                alert(val);
            }
            else {
                get_genome_info();
                $("#genome_info_edit_box").dialog('close');
            }
        }
    });
}

function delete_genome () {
    $.ajax({
        data: {
            fname: 'delete_genome',
            gid: genome_id,
        },
        success : function(rc) {
            if (rc) {
                location.reload();
            }
            else {
                alert('Error occurred!');
            }
        },
    });
}

function show_error() {
    $('#export_loading_msg').hide();
    $('#export_finished_msg').hide();
    $('#export_error_msg').fadeIn();
}

function show_success() {
    $('#export_ok_button').fadeIn();
    $('#export_loading_msg').hide();
    $('#export_finished_msg').fadeIn();
    $('#export_ok_button').fadeIn();
}

function get_gff($chr) {
    var id = genome_id;
    $('#gff_export').dialog('option', 'width', 400).dialog('open');

    $('#gff_submit').unbind().click(function(event, ui) {
        var id_type = $('#gff_id_type').val(),
            cds = +$('#cds_only')[0].checked,
            chr = +$chr,
            annos = +$('#annos')[0].checked,
            nu = +$('#name_unique')[0].checked,
            upa = +$('#upa')[0].checked;

        var height = $('#status_log')[0].scrollHeight;
        $("#status_log").animate({ scrollTop: height}, 500);

        var title = $("<br><h4>Generating GFF file</h4>");

        // RESET DIALOG
        reset_dialog();

        $("#export_log")
            .html(title)
            .append(note)

        $("#export_dialog")
            .unbind()
            .dialog({ title: "Preparing download", autoOpen: true});

        $.ajax({
            dataType: "json",
            data: {
                fname: "get_gff",
                gid: id,
                id_type: id_type,
                cds: cds,
                annos: annos,
                nu: nu,
                upa: upa,
                chr: $chr
            },
            success: function(json) {
                if (json.error) {
                    show_error();
                    $("#export_log").html(download_error);
                } else {
                    $('#export_log').append('<br><br>File: ' + json.file);
                    show_success();
                    $("#export_dialog").on("dialogclose", function(event, ui){
                        json.files.forEach(coge.utils.open);
                    });
                }
            }
        });
    });
}

function get_tbl() {
    var title = $("<h4>Generating tbl file</h4>");

    reset_dialog();

    $("#export_log")
        .html(title)
        .append(note);

    $("#export_dialog")
        .unbind()
        .dialog({ title: "Preparing download", autoOpen: true});

    $.ajax({
        dataType: "json",
        data: {
            fname: "get_tbl",
            gid: genome_id
        },
        success: function(json) {
            if (json.error) {
                show_error();
                $("#export_log").html(download_error);
            } else {
                $('#export_log').append('<br><br>File: ' + json.file);
                show_success();
                $("#export_dialog").on("dialogclose", function(event, ui){
                    json.files.forEach(coge.utils.open);
                });
            }
        }
    });
}

function get_bed() {
    var title = $("<h4>Generating bed file</h4>");

    reset_dialog();

    $("#export_log")
        .html(title)
        .append(note);

    $('#export_dialog')
        .unbind()
        .dialog({ title: "Preparing download", autoOpen: true});

    $.ajax({
        dataType: "json",
        data: {
            fname: "get_bed",
            gid: genome_id
        },
        success: function(json) {
            if (json.error) {
                $('#export_loading_msg').hide();
                $('#export_finished_msg').hide();
                $('#export_error_msg').fadeIn();
                $("#export_log").html(download_error);
            } else {
                $('#export_log').append('<br><br>File: ' + json.file);
                $('#export_ok_button').fadeIn();
                $('#export_loading_msg').hide();
                $('#export_finished_msg').fadeIn();
                $('#export_ok_button').fadeIn();
                $("#export_dialog").on("dialogclose", function(event, ui){
                    json.files.forEach(coge.utils.open);
                });
            }
        }
    });
}

function reset_dialog() {
    $('#export_finished_msg').hide();
    $('#export_ok_button').hide();
    $('#export_error_msg').hide();
    $('#export_loading_msg').show();
}

function export_gff(chr) {
    $('#gff_export').dialog('option', 'width', 400).dialog('open');
    $('#gff_submit').unbind().click(function() {

        // ANALYSIS OPTIONS
        var id = genome_id;
        var id_type = $('#gff_id_type').val(),
            cds = +$('#cds_only')[0].checked,
            annos = +$('#annos')[0].checked,
            nu = +$('#name_unique')[0].checked,
            upa = +$('#upa')[0].checked;

        // Prevent concurrent executions
        if ( $("#export_dialog").dialog( "isOpen" ) )
            return;

        // Make sure user is still logged-in
        if (!check_and_report_login())
            return;

        // RESET DIALOG
        reset_dialog();

        var title = $("<h4>Generating gff and copying file</h4>");


        var link = $("<a></a>")
                .addClass("bold")
                .attr("href", DISCOVERY_ENVIRONMENT.concat(irods_home_path))
                .html(irods_home_path);

        $("#export_log")
            .html(title)
            .append(link)
            .append(note);

        $("#export_dialog")
            .unbind()
            .dialog({ title: "Exporting file", autoOpen: true});

        $.ajax({
            dataType: "json",
            data: {
                fname: "export_gff",
                gid: id,
                id_type: id_type,
                cds: cds,
                annos: annos,
                nu: nu,
                upa: upa,
                chr: chr
            },
            success: function(json) {
                $('#export_log').append('<br><br>File: ' + json.file);
                if (json.error) {
                    show_error();
                } else {
                    show_success();
                }
            }
        });
    });
}

function export_to_irods(file_description, fname, data) {
    // Prevent concurrent executions
    if ( $("#export_dialog").dialog( "isOpen" ) )
        return;

    // Make sure user is still logged-in
    if (!check_and_report_login())
        return;

    // RESET DIALOG
    reset_dialog();

    // Open status dialog right away
    $('#export_dialog')
        .unbind()
        .dialog('open');

    var link = $("<a></a>")
            .addClass("bold")
            .attr("href", DISCOVERY_ENVIRONMENT.concat(irods_home_path))
            .html(irods_home_path);

    $('#export_log').html(
        "<br>Copying " + file_description + " to <br><br>"
    ).append(link);

    if (!data)
    	data = {};
    data.fname = fname;
    data.gid = genome_id;
    $.ajax({
        dataType: "json",
        data: data,
        success: function(json) {
            $('#export_log').append('<br><br>File: ' + json.file);

            if (json.error) {
                show_error();
            } else {
                show_success();
            }
        }
    });
}

function export_tbl() {
	export_to_irods("this genomes's TBL file", "export_tbl");
}

function export_bed() {
	export_to_irods("this genomes's BED file", "export_bed");
}

function export_fasta() {
	export_to_irods("this genomes's FASTA file", "export_fasta");
}

function export_fasta_chr(chr) {
    $.ajax({
        data: {
            fname: 'cache_chr_fasta',
            gid: genome_id,
            chr: chr
        },
        success: function(data) {
        	var obj = jQuery.parseJSON(data);
        	export_to_irods("this chromosome's FASTA file", "export_fasta_chr", { chr: chr, file: obj.file });
        }
    });
}

function reset_log() {
    $('#status_log').html('');
    $('#status_msg').show();
    $('#finished_msg,#error_msg,#ok_button').hide();
    $('#finish_button,#cancel_button').hide();
}

function reset_load() {
    window.history.pushState({}, "Title", PAGE_NAME + "?gid=" + genome_id);
    $('#load_dialog').dialog('close');
}

function load_failed(obj) {
    // Handle special case of genbank load of existing genome - FIXME: should this be here or miscopy from LoadGenome.tmpl?
    if ( obj && obj.links && obj.links.length ) {
        var link_text = obj.links.reduce(function(prev, cur) {
                return prev + '<a href="' + cur + '" target=_new>' + cur + '</a>' + '<br>';
            },
            '<b>Cannot load because the data already exist in the system:</b><br>');
        var log = $('#load_log');
        log.html( log.html() + link_text );
    }
	else { // mdb added 6/24/14 - temporary message until JEX logging is improved
		var msg =
			'<div class="alert">' +
			'The CoGe Support Team has been notified of this error but please ' + 
			'feel free to contact us at <a href="mailto:<TMPL_VAR NAME=SUPPORT_EMAIL>"><TMPL_VAR NAME=SUPPORT_EMAIL></a> ' +
			'and we can help to determine the cause.' +
			'</div>';
		var log = $('#load_log');
		log.html( log.html() + msg );
	}

    // Update dialog
    $('#loading_msg').hide();
    $('#error_msg').fadeIn();
    $('#cancel_button').fadeIn();

    if (newLoad) { // mdb added check to prevent redundant emails, 8/14/14 issue 458
	    $.ajax({
	        data: {
	            fname: "send_error_report",
	            load_id: load_id,
	            job_id: job_id
	        }
	    });
    }
}

function load_succeeded(obj) {
    // Update globals
    genome_id = obj.genome_id; // for continuing to GenomeInfo

    // Update dialog
    $('#loading_msg').hide();
    $('#finished_msg,#finish_button,#ok_button').fadeIn();
}

function check_login() {
    var logged_in = false;

    $.ajax({
        async: false,
        data: {
            fname: 'check_login'
        },
        success : function(rc) {
            logged_in = rc;
        }
    });

    return logged_in;
}

function check_and_report_login() {
    if (!check_login()) {
        alert('Your session has expired, please log in again.');
        location.reload(true)
        return false;
    }
    return true;
}

function copy_genome(mask, seq_only) {
    // Prevent concurrent executions - issue 101
    if ( $("#status_dialog").dialog( "isOpen" ) )
        return;

    // Make sure user is still logged-in - issue 206
    check_and_report_login();

    // Open status dialog right away - issue 101
    reset_log();

    $('#load_dialog').dialog('open');
//   $('#status_log').html('Initializing ...');
    newLoad = true;
    
    $.ajax({
        dataType: "json",
        data: {
            fname: 'copy_genome',
            load_id: load_id,
            gid: genome_id,
            mask: mask,
            seq_only: seq_only,
            timestamp: new Date().getTime()
        },
        success : function(data) {
            if (data.error) {
                alert(data.error);
                return;
            }

            job_id = data.job_id;

            // Set link in status dialog
            $('#loading_msg span a').attr('href', data.link).html(data.link);

            // Add load_id to browser URL
            window.history.pushState({}, "Title", PAGE_NAME + "?gid=" + genome_id + "&job_id=" + data.job_id); // Add job_id to browser URL
            update_dialog("api/v1/jobs/" + data.job_id, pageObj.user, "#load_dialog", progress_formatter);
        }
        // TODO: handle error, show in status dialog
    });
}

function progress_formatter(item) {
    var msg;
    var row = $('<li>'+ item.description + ' </li>');

    var job_status = $('<span></span>');

    if (item.status == 'scheduled')
        job_status.append(item.status).addClass('down bold');
    else if (item.status == 'completed')
        job_status.append(item.status).addClass('completed bold');
    else if (item.status == 'running')
        job_status.append(item.status).addClass('running bold');
    else if (item.status == 'skipped')
        job_status.append("already generated").addClass('skipped bold');
    else if (item.status == 'cancelled')
        job_status.append(item.status).addClass('alert bold');
    else if (item.status == 'failed')
        job_status.append(item.status).addClass('alert bold');
    else
        return;

    row.append(job_status);

    if (item.elapsed)  {
        row.append(" in " + coge.utils.toPrettyDuration(item.elapsed));
    }

    if (item.log) {
        var p = item.log.split("\n");

        var pElements = p.map(function(item) {
            var norm = item.replace(/\\t/g, " ").replace(/\\'/g, "'");
            return $("<div></div>").append(norm);
        });

        var log = $("<div></div>").html(pElements).addClass("padded");
        row.append(log);
    }

    return row;
}

function update_dialog(request, user, identifier, formatter) {
    var get_status = function () {
        $.ajax({
            type: 'GET',
            url: request,
            dataType: 'json',
            data: {
                username: user
            },
            success: update_callback,
            error: update_callback,
            xhrFields: {
                withCredentials: true
            }
        });
    };

    var update_callback = function(json) {
        var dialog = $(identifier);
        var workflow_status = $("<p></p>");
        var data = $("<ul></ul>");
        var results = [];
        var current_status;
        var timeout = 2000;

        var callback = function() {
            update_dialog(request, user, identifier, formatter);
        }

        if (json.error) {
            pageObj.error++;
            if (pageObj.error > 3) {
                workflow_status.html('<span class=\"alert\">The job engine has failed.</span>');
                load_failed();
                return;
            }
        } else {
            pageObj.error = 0;
        }

        if (json.status) {
            current_status = json.status.toLowerCase();
            workflow_status.html("Workflow status: ");
            workflow_status.append($('<span></span>').html(json.status));
            workflow_status.addClass('bold');
        } else {
            setTimeout(callback, timeout);
            return;
        }

        if (json.tasks) {
            var jobs = json.tasks;
            for (var index = 0; index < jobs.length; index++) {
                var item = formatter(jobs[index]);
                if (item) {
                    results.push(item);
                }
            }
        }

        if (!dialog.dialog('isOpen')) {
            return;
        }

        //FIXME Update when a workflow supports elapsed time
        if (current_status == "completed") {
            var total = json.tasks.reduce(function(a, b) {
                if (!b.elapsed) return a;

                return a + b.elapsed;
            }, 0);

            var duration = coge.utils.toPrettyDuration(total);

            workflow_status.append("<br>Finished in " + duration);
            workflow_status.find('span').addClass('completed');
            get_load_log(function(result) {
                load_succeeded(result);
            });

        }
        else if (current_status == "failed"
                || current_status == "error"
                || current_status == "terminated"
                || current_status == "cancelled")
        {
            workflow_status.find('span').addClass('alert');
            get_load_log(function(result) {
                load_failed(result);
            });
        }
        else if (current_status == "notfound") {
            setTimeout(callback, timeout);
            return;
        }
        else {
            workflow_status.find('span').addClass('running');
            setTimeout(callback, timeout);
        }

        results.push(workflow_status);
        data.append(results);
        dialog.find('#load_log').html(data);
    };

    get_status();
}

function get_load_log(callback) {
    $.ajax({
        dataType:    'json',
        data: {
            fname:       'get_progress_log',
            workflow_id: job_id,
            timestamp:   new Date().getTime()
        },
        success : function(data) {
            if (callback) {
                callback(data);
                return;
            }
        }
    });
}

function continue_to_view() {
    window.location.href = "GenomeInfo.pl?gid=" + genome_id;
}

function set_annotation_table() {
    $('#genome_annotation_table').tablesorter({widgets: ['zebra']});
}

function get_annotations() {
    $.ajax({
        data: {
            fname: 'get_annotations',
            gid: genome_id,
        },
        success : function(data) {
            $('#genome_annotations').html(data);
            set_annotation_table();
        }
    });
}

function remove_annotation (gaid) {
    $.ajax({
        data: {
            fname: 'remove_annotation',
            gid: genome_id,
            gaid: gaid,
        },
        success : function() {
            get_annotations();
        },
    });
}

function get_datasets() {
    $.ajax({
        data: {
            fname: 'get_datasets',
            gid: genome_id,
        },
        success : function(data) {
            $('#datasets').html(data);
        }
    });
}

function delete_dataset (dsid) {
    $.ajax({
        data: {
            fname: 'delete_dataset',
            gid: genome_id,
            dsid: dsid,
        },
        success : function() {
            get_datasets();
        },
    });
}

function open_aa_usage_table(chromosome)
{

    $("#aa_usage_table")
        .html("Please wait... ")
        .append(spinner.clone())
        .dialog({
            autoOpen: true,
            position: {
                my: "center",
                at: "top",
                of: ".box"
            }
        });

    $.ajax({
        data: {
            fname: "get_aa_usage",
            dsgid: genome_id,
            chr: chromosome
        },
        dataType: "html",
        success: function(html) {
            $('#aa_usage_table').html(html);
            $('#aa_table').tablesorter();
        }
    });
    
    return false;
}

function get_content_dialog(id, request, chromosome) {
    var elem = $(id);

    chromosome = (chromosome === "") ? undefined : chromosome;

    elem.dialog('option', 'position', {
        my: "center",
        at: "top",
        of: ".box"
    });

    elem.html("Please wait... ")
        .append(spinner.clone())
        .dialog('open')

    $.ajax({
        data: {
            fname: request,
            dsgid: genome_id,
            chr: chromosome,
        },
        dataType: "html",
        success: function(html) {
        	console.log(html);
            elem.html(html).slideDown();
        }
    })
}

function get_experiments(e) {
    e.preventDefault();
    var experiments = $("#experiments");
    experiments.html("Loading experiments... ").append(spinner.clone());

    $.ajax({
        data: {
            fname: 'get_experiments',
            gid: genome_id
        },
        success:function(html) {
            experiments
            	.hide()
            	.html(html)
            	.slideDown();
            var count = experiments.find('span').length;
            $('#exp_count').html('('+count+')').show();
        }
    });
}

</script>

<div class="dialog_box hidden" id="chromosome_hist" title="Chromosome Size"></div>
<div class="dialog_box hidden" id="chromosome_list" title="Chromosome List">
	<div id="chr_list_loading">Loading...</div>
	<div id="chr_list" style="display:none;">
		<table id="chr_list_table" class="display">
			<thead><tr><th>Chromosome</th><th>Length</th><th style="text-align:right;">Files</th><th></th></thead>
			<tbody></tbody>
		</table>
		<span onclick="export_chr_file()" class="r ui-button ui-corner-all coge-button" style="margin-left:10px;margin-top:10px;">Send to iPlant</span>
		<span onclick="download_chr_file()" class="r ui-button ui-corner-all coge-button" style="margin-top:10px;">Download</span>
	</div>
</div>
<div class="dialog_box hidden" id="gc_histogram" title="Chromosome Size"></div>
<div class="dialog_box hidden" id="wobble_gc_histogram" title="Histogram of Wobble GC Content for CDS"></div>
<div class="dialog_box hidden" id="wobble_gc_diff_histogram" title="(CDS GC - wobble GC) Content Histogram"></div>
<div class="dialog_box hidden" id="codon_usage_table" title="Codon Usage Table"></div>
<div class="dialog_box hidden" id="aa_usage_table" title="Amino Acid Usage Table"></div>
<div class="dialog_box hidden" id="edit_genome_info" title="Edit Genome Information"></div>

<TMPL_IF NAME='ADMIN_AREA'>
    <div class="alert">You are a CoGe Admin. Use your power wisely</div>
</TMPL_IF>

<table style="overflow:hidden;">
    <tr class="top">
        <td>
            <span class="bold text">Info</span>
            <div id='genome_info' style="width:400px;"><TMPL_VAR NAME="GENOME_INFO"></div>

            <div class="panel">
                <TMPL_IF NAME='USER_CAN_EDIT'>
                    <span class='ui-button ui-corner-all coge-button' onClick="edit_genome_info();">Edit Info</span>
                </TMPL_IF>
                <TMPL_IF NAME='USER_CAN_DELETE'>
                    <TMPL_IF NAME='DELETED'>
                        <span class='ui-button ui-corner-all ui-button-go coge-button' onClick="delete_genome();">Undelete</span>
                    <TMPL_ELSE>
                        <span class='ui-button ui-corner-all ui-button-go coge-button' onClick="$('#genome_delete_box').dialog('open');">Delete</span>
                    </TMPL_IF>
                </TMPL_IF>
                <span class='ui-button ui-corner-all coge-button' onclick='location.href="GenomeView.pl?embed=<TMPL_VAR NAME=EMBED>&gid=<TMPL_VAR NAME=GID>"'>Browse</span>
            </div>

            <TMPL_IF NAME="GENOME_ANNOTATIONS">
            <div style="padding-top:1em;">
	            <div class="bold text">Metadata</div>
	            <div id="genome_annotations">
	            	<TMPL_VAR NAME="GENOME_ANNOTATIONS">
	            </div>
            </div>
            </TMPL_IF>

            <div class="bold text" style="padding-top:1em;">Sequence & Gene Annotation</div>
            <TMPL_IF NAME='DATASETS'>
                <table id="datasets" class="small border-top border-bottom" style="color:gray;">
                    <TMPL_VAR NAME='DATASETS'>
                </table>
            </TMPL_IF>
            <TMPL_IF NAME='USER_CAN_EDIT'>
                <div class="panel">
                    <span class='ui-button ui-corner-all coge-button' onclick="location.href='LoadAnnotation.pl?embed=<TMPL_VAR NAME=EMBED>&gid=<TMPL_VAR NAME=GID>'">Load Gene Annotation</span>
                </div>
            </TMPL_IF>
        </td>

        <td style="padding-left:2em;">
            <TMPL_VAR NAME="GENOME_DATA">
            <div class="left coge-table-header">Tools</div>
            <table class="border-top">
                <tr>
                    <td class='title5'>Download:</td>
                    <td class='data5'>	
                        <a class='link' href='<TMPL_VAR NAME="DOWNLOAD_URL">'>FASTA</a>&nbsp|
                        <span class='link' onclick="get_gff()">GFF</span>&nbsp|
                        <span class='link' onclick="get_tbl()">TBL</span>&nbsp|
                        <span class='link' onclick="get_bed()">BED</span>
                    </td>
                </tr>
                <TMPL_IF NAME="LOGON">
                <tr>
                    <td class='title5'>Export to iPlant Data Store:</td>
                    <td class='data5'>
                        <span class='link' ondblclick="export_fasta()" onclick="export_fasta()">FASTA</span>
                        &nbsp|
                        <span class='link' ondblclick="export_gff()" onclick="export_gff()">GFF</span>&nbsp|
                        <span class='link' ondblclick="export_tbl()" onclick="export_tbl()">TBL</span>&nbsp|
                        <span class='link' ondblclick="export_bed()" onclick="export_bed()">BED</span>
                    </td>
                </tr>
                <tr>
                    <td class='title5'>Duplicate:</td>
                    <td class='data5'>
                        <span class='link' onDblClick="copy_genome(0,0);" onClick="copy_genome(0,0);">Copy</span>&nbsp|
                        <span class='link' onDblClick="copy_genome(0,1);" onClick="copy_genome(0,1);">Copy (No Annotations)</span>&nbsp|
                        <span class='link' onDblClick="copy_genome(1,0);" onClick="copy_genome(1,0);">Copy & Mask</span>&nbsp|
                        <span class='link' onClick="window.open('LoadGenome.pl?oid=<TMPL_VAR NAME=OID>')">Load new version</span>
                    </td>
                </tr>
                </TMPL_IF>
                <tr>
                    <td class='title5'>Analyze:</td>
                    <td class='data5'>
                        <a href='OrganismView.pl?dsgid=<TMPL_VAR NAME=GID>' target=_new>OrganismView</a>&nbsp|
                        <a href='CodeOn.pl?dsgid=<TMPL_VAR NAME=GID>' target=_new>CodeOn</a>&nbsp|
                        <span class='link' onclick="window.open('SynMap.pl?dsgid1=<TMPL_VAR NAME=GID>;dsgid2=<TMPL_VAR NAME=GID>');">SynMap</span>&nbsp|
                        <span class='link' onclick="window.open('CoGeBlast.pl?dsgid=<TMPL_VAR NAME=GID>');">CoGeBlast</span>
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>

<div class="bold text" style="padding-top:1em;">Experiments <span id="exp_count" <TMPL_UNLESS NAME="EXP_COUNT">class="hidden"</TMPL_UNLESS> >(<TMPL_VAR NAME="EXP_COUNT">)</span></div>
<TMPL_IF NAME='EXPERIMENTS'>
    <table class="small border-top border-bottom">
        <tr>
            <td>
                <TMPL_VAR NAME='EXPERIMENTS'>
            </td>
        </tr>
    </table>
</TMPL_IF>
<TMPL_IF NAME='USER_CAN_ADD'>
    <div class="panel">
        <span class='ui-button ui-corner-all coge-button' onclick="location.href='LoadExperiment.pl?embed=<TMPL_VAR NAME=EMBED>&gid=<TMPL_VAR NAME=GID>'">Load Experiment</span>
    </div>
</TMPL_IF>
<br><br>

<div id="genome_info_edit_box" class="dialog_box hidden" title="Edit Genome Info"></div>
<div id="genome_notebooks_edit_box" class="dialog_box hidden" title="Add to Notebook"></div>
<div id="genome_users_edit_box" class="dialog_box hidden" title="Add Users"></div>
<div id="genome_groups_edit_box" class="dialog_box hidden" title="Add Groups"></div>

<div id="gff_export" class="dialog_box hidden" title="GFF Exporter">
	<table class=small>
	 <tr>
	   <td>Do not generate features for ncRNA genes (CDS genes only)</td>
	   <td><input type=checkbox name="cds_only" id="cds_only"></td>
	 </tr>
	 <tr>
	   <td>Include feature annotations (descriptive text; Geneontology; etc)</td>
	   <td><input type=checkbox name="annos" id="annos" checked></td>
	 </tr>
	 <tr>
	   <td>Ensure that GFF Name tag is unique for each feature</td>
	   <td><input type=checkbox name="name_unique" id="name_unique" checked></td>
	 </tr>
	 <tr>
	   <td>Do not propagate duplicate annotations to children</td>
	   <td><input type=checkbox name="upa" id="upa" checked></td>
	 </tr>
	 <tr>
	   <td>For GFF "ID" and "Parent" tags, use unique:
	   <td>
	     <select id="gff_id_type">
	      <option value="name" selected>Name</option>
	      <option value="num">Number</option>
	     </select>
	 </tr>
	</table>
	<span id="gff_submit" class="ui-button ui-corner-all coge-button" style="margin-top:1em;" onClick="$('#gff_export').dialog('close');">Export GFF File</span>
	<br><br><span class="small" id="export_gff_link"></span>
</div>

<div id="genome_delete_box" class="dialog_box hidden" title="Delete genome?" align='center'>
Are you sure you want to move this genome into your trash?<p>
 <div>
  <span style="font-size:.75em" class='ui-button ui-corner-all ui-button-go coge-button' onClick="delete_genome();">Yes</span>
  <span style="font-size:.75em" class='ui-button ui-corner-all coge-button' onClick="$('#genome_delete_box').dialog('close');">No</span>
 </div>
</div>

<div id="status_dialog" class="hidden dialog_box">
    <div id="status_log" class="small text padded ui-widget-content ui-corner-all" style="overflow-y:auto;width:450px;height:200px;">
    </div>
    <br>
    <div id="status_msg">
      <!--<span class="small" style="float:right;">Link: <a href='<TMPL_VAR NAME="LINK">'><TMPL_VAR NAME="LINK"></a></span>-->
      Please wait ... <img src="picts/ajax-loader.gif"/>
    </div>
    <span id="finished_msg" class="hidden">Finished! <img src="picts/thumbs_up.png"></span>
    <input id="new_genome_id" type="hidden" />
    <span id="ok_button" onClick="$('#status_dialog').dialog('close');" style="float:right;" class="hidden ui-button ui-corner-all coge-button">OK</span>
    <span id="finish_button" onClick="continue_to_view();" style="float:right;" class="hidden ui-button ui-corner-all coge-button">Go to new genome</span>
    <span id="cancel_button" onClick="$('#status_dialog').dialog('close');" style="float:right;" class="hidden ui-button ui-corner-all ui-button-go coge-button">Cancel</span>
</div>

<div id="export_dialog" class="hidden dialog_box" title="Exporting ...">
    <div id="export_log" class="center text ui-widget-content ui-corner-all" style="overflow-y:auto;width:450px;height:200px;">
    </div>
    <br>
    <span id="export_loading_msg">Please wait ... <img src="picts/ajax-loader.gif"/></span>
    <span id="export_finished_msg" class="hidden">Finished! <img src="picts/thumbs_up.png"></span>
    <span id="export_error_msg" class="hidden">An error occurred <img style="vertical-align:text-top" src="picts/thumbs_down.png"></span>
    <span id="export_ok_button" onClick="$('#export_dialog').dialog('close');" style="float:right;" class="hidden ui-button ui-corner-all coge-button">OK</span>
</div>

<div id="load_dialog" class="hidden dialog_box" title="Copying Genome">
	<div id="load_log" class="small text padded ui-widget-content ui-corner-all" style="overflow-y:auto;width:450px;height:200px;">
	</div>
	<br>
	<div id="loading_msg">
	  <span class="small" style="float:right;">Link: <a></a></span>
	  Please wait ... <img src="picts/ajax-loader.gif"/>
	</div>
    <div class="coge-buttonset">
        <span id="finished_msg" class="hidden">Finished! <img src="picts/thumbs_up.png"></span>
        <span id="error_msg" class="hidden">An error occurred <img style="vertical-align:text-top" src="picts/thumbs_down.png"></span>
        <span id="ok_button" onClick="reset_load();" style="float:right;" class="hidden ui-button ui-corner-all coge-button">OK</span>
        <span id="finish_button" onClick="continue_to_view();" style="float:right;" class="hidden ui-button ui-corner-all coge-button">Continue to new copy</span>
        <span id="cancel_button" onClick="reset_load();" style="float:right;" class="hidden ui-button ui-corner-all ui-button-go coge-button">Cancel</span>
    </div>
</div>

<TMPL_INCLUDE NAME='widgets/AddAnnotation.tmpl'>

</TMPL_IF>

<TMPL_IF NAME="DO_GENOME_INFO">
    <table class="border-top border-bottom">
        <tr>
            <td class='title5' style='white-space:nowrap;'>Genome ID:</td>
            <td class='data5'><TMPL_VAR NAME="GID"></td>
        </tr>
        <tr>
            <td class='title5' style='white-space:nowrap;'>Organism:</td>
            <td class='data5'><span class="link" onclick="window.open('OrganismView.pl?gid=<TMPL_VAR NAME=GID>')"><TMPL_VAR NAME="ORGANISM"></span></td>
        </tr>
        <tr>
            <td class='title5' style='white-space:nowrap;'>Version:</td>
            <td class='data5'><TMPL_VAR NAME="VERSION"></td>
        </tr>
        <tr>
            <td class='title5' style='white-space:nowrap;'>Type:</td>
            <td class='data5'><TMPL_VAR NAME="TYPE"></td>
        </tr>
        <tr>
            <td class='title5' style='white-space:nowrap;'>Source:</td>
            <td class='data5'><TMPL_VAR NAME="SOURCE"></td>
        </tr>
        <tr>
            <td class='title5' style='white-space:nowrap;'>Link:</td>
            <td class='data5'><span class="link" onclick="window.open('<TMPL_VAR NAME=LINK>')"><TMPL_VAR NAME="LINK"></span></td>
        </tr>
        <tr>
            <td class='title5' style='white-space:nowrap;'>Name:</td>
            <td class='data5'><TMPL_VAR NAME="NAME"></td>
        </tr>
        <tr>
            <td class='title5' style='white-space:nowrap;'>Description:</td>
            <td class='data5'><TMPL_VAR NAME="DESCRIPTION"></td>
        </tr>
        <tr>
            <td class='title5' style='white-space:nowrap;'>Restricted:</td>
            <td class='data5'><TMPL_VAR NAME="RESTRICTED"></td>
        </tr>
        <tmpl_if name="creator">
        <tr>
            <td class='title5' style='white-space:nowrap;'>Creation:</td>
            <td class='data5'><TMPL_VAR NAME="creator"></td>
        </tr>
        </tmpl_if>
        <tmpl_if name="owner">
        <tr>
            <td class='title5' style='white-space:nowrap;'>Owner:</td>
            <td class='data5'><tmpl_var name="owner"></td>
        </tr>
        </tmpl_if>
        <tr>
            <td class='title5' valign='top' style='white-space:nowrap;'>Users with access:</td>
            <td class='data5'><TMPL_VAR NAME="USERS_WITH_ACCESS"></td>
        </tr>
        <tmpl_if name="groups_with_access">
        <tr>
            <td class='title5' valign='top' style='white-space:nowrap;'>Groups with access:</td>
            <td class='data5'><tmpl_var name="groups_with_access"></td>
        </tr>
        </tmpl_if>
        <TMPL_IF NAME="DELETED">
        <tr>
            <td class='alert' style='white-space:nowrap;'>Note:</td>
            <td class='alert'>This genome is deleted</td>
        </tr>
        </TMPL_IF>
    </table>
</TMPL_IF>

<TMPL_IF NAME="EDIT_GENOME_INFO">
    <script>
    $(function() {
        $("#edit_source").autocomplete({source: <TMPL_VAR NAME='SOURCES'>});
    });
    </script>

    <table class="small">
      <tr>
        <td>Organism:</td>
        <td>
          <input id="edit_organism" type="search" onkeyup="debounce_search(search_organisms, this.value);" size="50" value="<TMPL_VAR NAME='ORGANISM'>"/>
          <!--<span id="new_organism_button" onClick="$('#create_new_organism_dialog').dialog('open'); activate_on_input('edit_organism_name', 'create_organism_button');" class='ui-button ui-corner-all coge-button'>New</span>-->
        </td>
      </tr>
      <tr>
        <td>Version:</td>
        <td><input id="edit_version" type="textbox" size="10" value="<TMPL_VAR NAME='VERSION'>" /></td>
      </tr>
      <tr>
        <td>Type:</td>
        <td>
          <select id="select_type" style="width:230px;" value="<TMPL_VAR NAME='TYPES'>"></select>
          <!-- <span id="new_type_button" onClick="$('#create_new_type_dialog').dialog('open'); activate_on_input('edit_type_name', 'create_type_button');" class='ui-button ui-corner-all coge-button'>New</span> -->
        </td>
      </tr>
      <tr>
        <td>Source:</td>
        <td>
          <input id="edit_source" type="search" size="50" value="<TMPL_VAR NAME='SOURCE'>"/>
          <!-- <span id="new_source_button" onClick="$('#create_new_source_dialog').dialog('open'); activate_on_input('edit_source_name', 'create_source_button');" class='ui-button ui-corner-all coge-button'>New</span> -->
        </td>
      </tr>
      <tr>
        <td>Link</td>
        <td><input id="edit_link" size="50" value="<TMPL_VAR NAME='LINK'>" /></td>
      </tr>
      <tr>
        <td>Restricted?</td>
        <td><input id="restricted" type="checkbox" <TMPL_IF NAME='RESTRICTED'>checked</TMPL_IF>></td>
      </tr>
      <tr>
        <td>Name:</td>
        <td><input id="edit_name" type="textbox" placeholder="Optional" size="50" value="<TMPL_VAR NAME='NAME'>" /></td>
      </tr>
      <tr>
        <td>Description:</td>
        <td><textarea id="edit_description" placeholder="Optional" rows="5" cols="50" ><TMPL_VAR NAME='DESCRIPTION'></textarea></td>
      </tr>
    </table>
    <br>
    <span onClick="update_genome_info();" class='ui-button ui-corner-all coge-button'>Update</span>
</TMPL_IF>

<TMPL_IF NAME='DO_EXPERIMENTS'>
    <TMPL_LOOP NAME="EXPERIMENT_LOOP">
        <TMPL_VAR NAME="EXPERIMENT_INFO"><br>
    </TMPL_LOOP>
</TMPL_IF>

<TMPL_IF NAME='NOEXPERIMENTS'>
    <div id="experiments" class="padded">
        <a href="#" onclick="get_experiments(window.event);">Click to display all Experiments</a>
    </div>
</TMPL_IF>


<TMPL_IF NAME='DO_DATASETS'>
    <TMPL_LOOP NAME="DATASET_LOOP">
        <tr>
            <td>
                <TMPL_VAR NAME="DATASET_INFO">
            </td>
            <!--
            <td>
                <span onClick='$(this).parent("tr").fadeOut("fast"); delete_dataset("<TMPL_VAR NAME=DATASET_ID>");' class='link ui-icon ui-icon-trash'></span>
            </td>
            -->
        </tr>
    </TMPL_LOOP>
</TMPL_IF>

<TMPL_IF NAME='ADMIN_AREA'>
    <script>
    $(document).ready(function() {
        $("#edit_user").autocomplete({
            source:[],
            focus: function() { return false; },
        });
    });
    function update_owner () {
        var user_name = $('#edit_user').val();
        if (!user_name) {
            alert('Please specify a user.');
            return;
        }

        $.ajax({
            data: {
                fname: 'update_owner',
                gid: "<TMPL_VAR NAME='GID'>",
                user_name: user_name,
                timestamp: new Date().getTime()
            },
            success : function(data) {
                if (data) {
                    alert(data);
                }
            }
        });
    }
    </script>
    <hr>
    <div class="bold text">Admin Functions</div>
    
    <div class="small padded">
    	<div>
	        Assign to user:
	        <input id="edit_user" type="search" placeholder="Search" onkeyup="wait_to_search(search_users, this.value);" size="10" />
	        <span onClick="update_owner();" class='ui-button ui-corner-all coge-button'>Go</span>
        </div>
        <div>
			<span>Load Log:</span>
		    <span id="log_button" onclick="toggle_load_log();" class='ui-button ui-corner-all coge-button' style="width:3em; margin-bottom:1em; overflow:auto;">Show</span>
		    <img id="log_spinner" src="picts/ajax-loader.gif" style="opacity: 0;"/>
		    <div id="log_contents" class="border hidden padded coge-code" style="border:1px solid gray; color: navy;"></div>
	    </div>
	</div>
</TMPL_IF>
